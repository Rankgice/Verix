# 一、总体设计原则
## 核心思想
`Case = Protocol + Request + Expect + Extract`

- 协议差异只体现在 `request.protocol.type`。
- 断言和 `diff` 结构完全统一。

# 二、输入用例结构定义（TestSpec v1）
## 顶层结构
```json
{
  "meta": {
    "name": "activity-service-test",
    "protocol_defaults": {
      "http": {
        "base_url": "http://127.0.0.1:8899",
        "headers": {}
      },
      "grpc": {
        "target": "127.0.0.1:50051",
        "plaintext": true,
        "metadata": {}
      }
    },
    "timeout_ms": 5000
  },
  "vars": {},
  "cases": []
}
```

# 三、Case 结构定义（统一模型）
```json
{
  "id": "create_activity",
  "name": "Create Activity",
  "protocol": {
    "type": "http"
  },
  "request": {},
  "expect": {},
  "extract": {}
}
```

# 四、Request 定义（协议分支）
## 1. HTTP 请求格式
```json
{
  "id": "create_activity",
  "protocol": {
    "type": "http"
  },
  "request": {
    "method": "POST",
    "path": "/v1/activity",
    "headers": {
      "Authorization": "Bearer {{vars.token}}"
    },
    "query": {},
    "body": {
      "name": "test_{{timestamp}}",
      "status": 1
    }
  },
  "expect": {}
}
```

说明：
- `path` 会自动拼接 `base_url`。
- 支持变量替换。
- `body` 默认 `JSON`。

## 2. gRPC 请求格式
```json
{
  "id": "create_activity_grpc",
  "protocol": {
    "type": "grpc"
  },
  "request": {
    "service": "activity.v1.ActivityService",
    "method": "CreateActivity",
    "metadata": {
      "authorization": "Bearer {{vars.token}}"
    },
    "message": {
      "name": "test_{{timestamp}}",
      "status": 1
    }
  },
  "expect": {}
}
```

说明：
- `service`：完整 proto service 名。
- `method`：rpc 名。
- `message`：protobuf JSON 表达形式。
- `metadata`：gRPC metadata。

# 五、Expect（统一断言模型）
## 核心设计目标
- HTTP / gRPC 统一断言模型。
- 支持状态断言。
- 支持结构断言。
- 支持类型断言。
- 支持值断言。

## Expect 结构定义
```json
{
  "expect": {
    "success": true,
    "status": 200,
    "grpc_code": "OK",
    "headers": {},
    "body": {
      "data.id": {
        "type": "string",
        "not_empty": true
      },
      "data.name": {
        "type": "string"
      },
      "code": {
        "equals": 0
      }
    }
  }
}
```

## 字段说明
- `success`：用于快速语义标记，不参与断言，只用于报告分组。
- `status`：仅 HTTP 使用，例如 `200`、`404`、`500`。
- `grpc_code`：仅 gRPC 使用，例如 `OK`、`InvalidArgument`、`Unauthenticated`、`Internal`。

## body 断言 DSL（核心）
每个字段路径支持：

| 规则 | 示例 |
|---|---|
| 类型断言 | `"type": "string"` |
| 精确匹配 | `"equals": 0` |
| 非空 | `"not_empty": true` |
| 存在 | `"exists": true` |
| 正则 | `"matches": "^test_"` |

支持数组断言示例：
```json
"data.list": {
  "type": "array",
  "min_items": 1
}
```

# 六、变量提取格式
```json
"extract": {
  "activity_id": "data.id",
  "first_name": "data.list[0].name"
}
```

- JSONPath 简化表达。
- 自动注入到 `vars`。

# 七、执行结果结构（中间产物）
每个 case 执行后产生：

```json
{
  "id": "create_activity",
  "protocol": "http",
  "endpoint": "POST /v1/activity",
  "duration_ms": 120,
  "status": 200,
  "grpc_code": null,
  "response_body": {},
  "error": null,
  "assertions": []
}
```

# 八、Diff 报告结构定义（最终输出）
这是最重要的部分，必须：
- 机器可读。
- 人类可读。
- 可供 LLM 分析。

## 顶层报告结构
```json
{
  "summary": {
    "total": 12,
    "passed": 10,
    "failed": 2,
    "duration_ms": 1450
  },
  "failed_cases": []
}
```

## 单个失败 Case 报告结构
```json
{
  "id": "update_activity",
  "protocol": "http",
  "endpoint": "PUT /v1/activity/123",
  "expected": {
    "status": 200,
    "body": {
      "data.name": {
        "type": "string"
      }
    }
  },
  "actual": {
    "status": 403,
    "body": {
      "message": "permission denied"
    }
  },
  "diff": [
    {
      "type": "status_mismatch",
      "path": "status",
      "expected": 200,
      "actual": 403
    },
    {
      "type": "missing_field",
      "path": "data.name",
      "expected": "string",
      "actual": "missing"
    }
  ],
  "diagnosis": [
    "Authentication token missing required role",
    "RBAC policy changed",
    "Route permission annotation mismatch"
  ]
}
```

# 九、Diff 类型枚举定义
```json
"type": one of [
  "status_mismatch",
  "grpc_code_mismatch",
  "missing_field",
  "unexpected_field",
  "type_mismatch",
  "value_mismatch",
  "regex_mismatch",
  "timeout",
  "connection_error"
]
```

# 十、gRPC 失败报告示例
```json
{
  "id": "create_activity_grpc",
  "protocol": "grpc",
  "endpoint": "activity.v1.ActivityService/CreateActivity",
  "expected": {
    "grpc_code": "OK"
  },
  "actual": {
    "grpc_code": "Unauthenticated",
    "message": "invalid token"
  },
  "diff": [
    {
      "type": "grpc_code_mismatch",
      "expected": "OK",
      "actual": "Unauthenticated"
    }
  ],
  "diagnosis": [
    "Missing authorization metadata",
    "Token expired",
    "Interceptor validation failed"
  ]
}
```

# 十一、设计亮点总结
这套结构具备：
- HTTP / HTTPS / gRPC 统一模型
- 强类型断言 DSL
- 可机器解析 diff
- 可供 LLM 做原因推断
- 可接入 CI
- 可做回归检测
- 可接入流量回放

| 模块 | 推荐库 |
|---|---|
| HTTP | `net/http` |
| gRPC | `google.golang.org/grpc` |
| gRPC 动态调用 | `grpcurl` |
| JSON 断言 | `gjson` |
| JSON 修改 | `sjson` |
| CLI | `cobra` |
| 并发 | `errgroup` |
| MCP | `github.com/modelcontextprotocol/go-sdk/mcp` |

